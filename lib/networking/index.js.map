{"version":3,"sources":["networking/index.js"],"names":["modules","_modules","Object","keys","forEach","key","bind","config","_config","_maxSubDomain","_currentSubDomain","Math","floor","random","_providedFQDN","secure","origin","_coreParams","shiftStandardOrigin","indexOf","newSubDomain","toString","replace","name","failover","_standardOrigin","nextOrigin","params","body","endpoint","callback","post","get","del","err","code","categoryConstants","PNNetworkIssuesCategory","status","hasOwnProperty","timeout","PNTimeoutCategory","response","badRequest","PNBadRequestCategory","forbidden","PNAccessDeniedCategory","PNUnknownCategory"],"mappings":"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","file":"index.js","sourcesContent":["/* @flow */\r\n\r\nimport Config from '../core/components/config';\r\nimport categoryConstants from '../core/constants/categories';\r\n\r\nimport { EndpointDefinition, NetworkingModules } from '../core/flow_interfaces';\r\n\r\nexport default class {\r\n  _modules: NetworkingModules;\r\n  _config: Config;\r\n\r\n  _maxSubDomain: number;\r\n  _currentSubDomain: number;\r\n\r\n  _standardOrigin: string;\r\n  _subscribeOrigin: string;\r\n\r\n  _providedFQDN: string;\r\n\r\n  _requestTimeout: number;\r\n\r\n  _coreParams: Object; /* items that must be passed with each request. */\r\n\r\n  constructor(modules: NetworkingModules) {\r\n    this._modules = {};\r\n\r\n    Object.keys(modules).forEach((key) => {\r\n      this._modules[key] = modules[key].bind(this);\r\n    });\r\n  }\r\n\r\n  init(config: Config) {\r\n    this._config = config;\r\n\r\n    this._maxSubDomain = 20;\r\n    this._currentSubDomain = Math.floor(Math.random() * this._maxSubDomain);\r\n    this._providedFQDN = (this._config.secure ? 'https://' : 'http://') + this._config.origin;\r\n    this._coreParams = {};\r\n\r\n    // create initial origins\r\n    this.shiftStandardOrigin();\r\n  }\r\n\r\n  nextOrigin(): string {\r\n    // if a custom origin is supplied, use do not bother with shuffling subdomains\r\n    if (this._providedFQDN.indexOf('pubsub.') === -1) {\r\n      return this._providedFQDN;\r\n    }\r\n\r\n    let newSubDomain: string;\r\n\r\n    this._currentSubDomain = this._currentSubDomain + 1;\r\n\r\n    if (this._currentSubDomain >= this._maxSubDomain) {\r\n      this._currentSubDomain = 1;\r\n    }\r\n\r\n    newSubDomain = this._currentSubDomain.toString();\r\n\r\n    return this._providedFQDN.replace('pubsub', `ps${newSubDomain}`);\r\n  }\r\n\r\n  hasModule(name: string) {\r\n    return name in this._modules;\r\n  }\r\n\r\n  // origin operations\r\n  shiftStandardOrigin(failover: boolean = false): string {\r\n    this._standardOrigin = this.nextOrigin(failover);\r\n\r\n    return this._standardOrigin;\r\n  }\r\n\r\n  getStandardOrigin(): string {\r\n    return this._standardOrigin;\r\n  }\r\n\r\n  POST(params: Object, body: string, endpoint: EndpointDefinition, callback: Function) {\r\n    return this._modules.post(params, body, endpoint, callback);\r\n  }\r\n\r\n  GET(params: Object, endpoint: EndpointDefinition, callback: Function) {\r\n    return this._modules.get(params, endpoint, callback);\r\n  }\r\n\r\n  DELETE(params: Object, endpoint: EndpointDefinition, callback: Function) {\r\n    return this._modules.del(params, endpoint, callback);\r\n  }\r\n\r\n  _detectErrorCategory(err: Object): string {\r\n    if (err.code === 'ENOTFOUND') return categoryConstants.PNNetworkIssuesCategory;\r\n    if (err.code === 'ECONNREFUSED') return categoryConstants.PNNetworkIssuesCategory;\r\n    if (err.code === 'ECONNRESET') return categoryConstants.PNNetworkIssuesCategory;\r\n    if (err.code === 'EAI_AGAIN') return categoryConstants.PNNetworkIssuesCategory;\r\n\r\n    if (err.status === 0 || (err.hasOwnProperty('status') && typeof err.status === 'undefined')) return categoryConstants.PNNetworkIssuesCategory;\r\n    if (err.timeout) return categoryConstants.PNTimeoutCategory;\r\n\r\n    if (err.code === 'ETIMEDOUT') return categoryConstants.PNNetworkIssuesCategory;\r\n\r\n    if (err.response) {\r\n      if (err.response.badRequest) return categoryConstants.PNBadRequestCategory;\r\n      if (err.response.forbidden) return categoryConstants.PNAccessDeniedCategory;\r\n    }\r\n\r\n    return categoryConstants.PNUnknownCategory;\r\n  }\r\n}\r\n"]}